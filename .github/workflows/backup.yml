name: ğŸ—„ï¸ Backup AutomÃ¡tico (Simples)

on:
  schedule:
    # Executa a cada 2 dias Ã s 3:00 AM UTC (0:00 BRT)
    - cron: '0 3 */2 * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

# PermissÃµes necessÃ¡rias para o workflow
# contents: write -> permite commit/push no job save-to-repo
# actions: write  -> necessÃ¡rio para deletar artifacts no job cleanup
permissions:
  contents: write
  actions: write

jobs:
  backup:
    name: ğŸ“¦ Backup Completo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ”§ Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ—„ï¸ Executar Backup AutomÃ¡tico (Debug)
        run: |
          echo "ğŸ“ Verificando estrutura de diretÃ³rios:"
          pwd
          ls -la
          echo ""
          echo "ğŸ“‚ Verificando pasta prisma:"
          ls -la prisma/ || echo "âŒ Pasta prisma nÃ£o encontrada"
          echo ""
          echo "ğŸ—„ï¸ Executando backup automÃ¡tico:"
          npm run backup:auto
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          BACKUP_WEBHOOK_URL: ${{ secrets.BACKUP_WEBHOOK_URL }}
          
      - name: ğŸ“¤ Upload Backups como Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_number }}
          path: |
            prisma/backups/backup_latest.js
            prisma/backups/backup_*.js
          retention-days: 90
          compression-level: 6
          
      - name: ğŸ’¾ Verificar Arquivos de Backup Criados
        run: |
          echo "ğŸ“‹ Arquivos de backup criados:"
          ls -la prisma/backups/ || echo "âŒ Pasta backups nÃ£o encontrada"
          echo ""
          echo "ğŸ“Š ConteÃºdo do backup_latest.js:"
          if [ -f "prisma/backups/backup_latest.js" ]; then
            echo "âœ… Backup latest existe ($(ls -lh prisma/backups/backup_latest.js | awk '{print $5}'))"
            head -20 prisma/backups/backup_latest.js
          else
            echo "âŒ backup_latest.js nÃ£o foi criado"
          fi
          
      - name: ğŸ“Š RelatÃ³rio Final
        run: |
          echo "## ğŸ“Š Backup AutomÃ¡tico ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ• Data/Hora:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Status:** Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“ Arquivos de Backup:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la prisma/backups/ | grep backup_ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ’¾ Artifacts:** Salvos por 90 dias" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ“‹ EstatÃ­sticas do Backup
        run: |
          BACKUP_COUNT=$(ls -1 prisma/backups/backup_*.js 2>/dev/null | wc -l)
          LATEST_SIZE=$(ls -lh prisma/backups/backup_latest.js | awk '{print $5}')
          echo "ğŸ“Š Total de backups: $BACKUP_COUNT"
          echo "ğŸ“„ Tamanho do backup: $LATEST_SIZE"
          
  # Limpeza automÃ¡tica de artifacts antigos
  cleanup:
    name: ğŸ§¹ Limpeza de Artifacts
    runs-on: ubuntu-latest
    needs: backup
    if: success() && github.event_name == 'schedule'
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: ğŸ—‘ï¸ Limpar artifacts antigos (manter 15 mais recentes)
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” Procurando artifacts de backup antigos...');
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const backupArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('backup-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            console.log(`ğŸ“Š Encontrados ${backupArtifacts.length} artifacts de backup`);
            
            const toDelete = backupArtifacts.slice(15); // Manter apenas os 15 mais recentes
            
            if (toDelete.length > 0) {
              console.log(`ğŸ—‘ï¸ Removendo ${toDelete.length} artifacts antigos...`);
              
              for (const artifact of toDelete) {
                try {
                  console.log(`âŒ Removendo: ${artifact.name} (${artifact.created_at})`);
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id,
                  });
                } catch (err) {
                  if (err.status === 403) {
                    console.log('âš ï¸ Sem permissÃ£o para remover este artifact (403). Verifique as permissÃµes do GITHUB_TOKEN.');
                  } else if (err.status === 404) {
                    console.log('â„¹ï¸ Artifact jÃ¡ inexistente (404), seguindo...');
                  } else {
                    throw err;
                  }
                }
              }
              
              console.log('âœ… Limpeza concluÃ­da!');
            } else {
              console.log('âœ… Nenhum artifact antigo para remover');
            }

  # Job para salvar backup no repositÃ³rio
  save-to-repo:
    name: ğŸ’¾ Salvar Backup no RepositÃ³rio
    runs-on: ubuntu-latest
    needs: backup
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ”§ Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ—„ï¸ Criar Backup
        run: npm run backup
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ“ Commit Backup no RepositÃ³rio
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Backup"
          
          # Adicionar apenas arquivos de backup
          git add prisma/backups/backup_latest.js
          git add prisma/backups/backup_*.js 2>/dev/null || true
          
          # Verificar se hÃ¡ mudanÃ§as para commit
          if git diff --staged --quiet; then
            echo "ğŸ“‹ Nenhuma mudanÃ§a no backup para commit"
          else
            git commit -m "ğŸ¤– Backup automÃ¡tico - $(date '+%Y-%m-%d %H:%M') - Run ${{ github.run_number }}"
            git push
            echo "âœ… Backup commitado com sucesso!"
          fi