name: üóÑÔ∏è Backup Autom√°tico (Simples)

on:
  schedule:
    # Executa a cada 2 dias √†s 3:00 AM UTC (0:00 BRT)
    - cron: '0 3 */2 * *'
  
  # Permite execu√ß√£o manual
  workflow_dispatch:

jobs:
  backup:
    name: üì¶ Backup Completo
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üìö Instalar depend√™ncias
        run: npm ci
        
      - name: üîß Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: üóÑÔ∏è Executar Backup Autom√°tico (Debug)
        run: |
          echo "üìÅ Verificando estrutura de diret√≥rios:"
          pwd
          ls -la
          echo ""
          echo "üìÇ Verificando pasta prisma:"
          ls -la prisma/ || echo "‚ùå Pasta prisma n√£o encontrada"
          echo ""
          echo "üóÑÔ∏è Executando backup autom√°tico:"
          npm run backup:auto
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          BACKUP_WEBHOOK_URL: ${{ secrets.BACKUP_WEBHOOK_URL }}
          
      - name: üì§ Upload Backups como Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_number }}
          path: |
            prisma/backups/backup_latest.js
            prisma/backups/backup_*.js
          retention-days: 90
          compression-level: 6
          
      - name: üíæ Verificar Arquivos de Backup Criados
        run: |
          echo "üìã Arquivos de backup criados:"
          ls -la prisma/backups/ || echo "‚ùå Pasta backups n√£o encontrada"
          echo ""
          echo "üìä Conte√∫do do backup_latest.js:"
          if [ -f "prisma/backups/backup_latest.js" ]; then
            echo "‚úÖ Backup latest existe ($(ls -lh prisma/backups/backup_latest.js | awk '{print $5}'))"
            head -20 prisma/backups/backup_latest.js
          else
            echo "‚ùå backup_latest.js n√£o foi criado"
          fi
          
      - name: üìä Relat√≥rio Final
        run: |
          echo "## üìä Backup Autom√°tico Conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "**üïê Data/Hora:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**‚úÖ Status:** Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "**üìÅ Arquivos de Backup:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la prisma/backups/ | grep backup_ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "**üíæ Artifacts:** Salvos por 90 dias" >> $GITHUB_STEP_SUMMARY
          
      - name: üìã Estat√≠sticas do Backup
        run: |
          BACKUP_COUNT=$(ls -1 prisma/backups/backup_*.js 2>/dev/null | wc -l)
          LATEST_SIZE=$(ls -lh prisma/backups/backup_latest.js | awk '{print $5}')
          echo "üìä Total de backups: $BACKUP_COUNT"
          echo "üìÑ Tamanho do backup: $LATEST_SIZE"
          
  # Limpeza autom√°tica de artifacts antigos
  cleanup:
    name: üßπ Limpeza de Artifacts
    runs-on: ubuntu-latest
    needs: backup
    if: success() && github.event_name == 'schedule'
    
    steps:
      - name: üóëÔ∏è Limpar artifacts antigos (manter 15 mais recentes)
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üîç Procurando artifacts de backup antigos...');
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const backupArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('backup-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            console.log(`üìä Encontrados ${backupArtifacts.length} artifacts de backup`);
            
            const toDelete = backupArtifacts.slice(15); // Manter apenas os 15 mais recentes
            
            if (toDelete.length > 0) {
              console.log(`üóëÔ∏è Removendo ${toDelete.length} artifacts antigos...`);
              
              for (const artifact of toDelete) {
                console.log(`‚ùå Removendo: ${artifact.name} (${artifact.created_at})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
              
              console.log('‚úÖ Limpeza conclu√≠da!');
            } else {
              console.log('‚úÖ Nenhum artifact antigo para remover');
            }