name: ğŸ—„ï¸ Backup AutomÃ¡tico

on:
  schedule:
    # Executa a cada 2 dias Ã s 3:00 AM UTC (0:00 BRT)
    - cron: '0 3 */2 * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  backup:
    name: ğŸ“¦ Criar Backup AutomÃ¡tico
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ”§ Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ—„ï¸ Executar Backup AutomÃ¡tico
        run: npm run backup:auto
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          BACKUP_WEBHOOK_URL: ${{ secrets.BACKUP_WEBHOOK_URL }}
          
      - name: ğŸ“¤ Upload Backup como Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            prisma/backups/backup_latest.js
            prisma/backups/backup_*.js
          retention-days: 90
          
      - name: ğŸ“Š RelatÃ³rio do Backup
        run: |
          echo "## ğŸ“Š RelatÃ³rio do Backup" >> $GITHUB_STEP_SUMMARY
          echo "**Data:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… ConcluÃ­do com sucesso" >> $GITHUB_STEP_SUMMARY
          echo "**Arquivos criados:**" >> $GITHUB_STEP_SUMMARY
          ls -la prisma/backups/ | grep backup_ | tail -5 >> $GITHUB_STEP_SUMMARY
          
  # Commit do backup no repositÃ³rio (opcional)
  commit-backup:
    name: ğŸ’¾ Salvar Backup no RepositÃ³rio
    runs-on: ubuntu-latest
    needs: backup
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ”§ Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ—„ï¸ Criar Backup
        run: npm run backup
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ğŸ“ Commit Backup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Backup"
          git add prisma/backups/backup_latest.js
          if git diff --staged --quiet; then
            echo "Nenhuma mudanÃ§a no backup"
          else
            git commit -m "ğŸ¤– Backup automÃ¡tico - $(date '+%Y-%m-%d %H:%M')"
            git push
          fi