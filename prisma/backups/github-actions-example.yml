# ðŸ¤– Exemplo de GitHub Action para Backup AutomÃ¡tico
#
# Salve este arquivo como: .github/workflows/backup.yml
# 
# Este workflow executa backup automÃ¡tico diariamente e 
# armazena os backups como artifacts do GitHub

name: ðŸ—„ï¸ Backup AutomÃ¡tico

on:
  schedule:
    # Executa a cada 2 dias Ã s 3:00 AM UTC (0:00 BRT)
    - cron: '0 3 */2 * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  backup:
    name: ðŸ“¦ Criar Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“š Instalar dependÃªncias
        run: npm ci
        
      - name: ðŸ”§ Setup Prisma
        run: npx prisma generate
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          
      - name: ðŸ—„ï¸ Criar Backup
        run: npm run backup:auto
        env:
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          BACKUP_WEBHOOK_URL: ${{ secrets.BACKUP_WEBHOOK_URL }}
          
      - name: ðŸ“¤ Upload Backup
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_number }}
          path: prisma/backups/backup_latest.js
          retention-days: 90
          
      - name: ðŸ“‹ Listar Backups
        run: |
          echo "ðŸ“Š Backups criados:"
          ls -la prisma/backups/
          
  # Job adicional para limpar artifacts antigos (opcional)
  cleanup:
    name: ðŸ§¹ Limpar Artifacts Antigos
    runs-on: ubuntu-latest
    needs: backup
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ—‘ï¸ Limpar artifacts antigos
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            // Manter apenas os 30 mais recentes
            const backupArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('backup-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            const toDelete = backupArtifacts.slice(30);
            
            for (const artifact of toDelete) {
              console.log(`Removendo artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }